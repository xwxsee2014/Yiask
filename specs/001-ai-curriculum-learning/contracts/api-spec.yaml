# API Specification - AI课程练习平台
# OpenAPI 3.0 Specification

openapi: 3.0.3
info:
  title: Yiask AI智能课程练习平台 API
  description: |
    基于AI的英语学习平台API，支持课程内容管理、练习生成、语音交互和学习进度跟踪。

    ## 功能模块

    - **用户认证**: JWT-based authentication
    - **课程管理**: 内容提供者创建和管理课程单元
    - **练习系统**: AI生成的练习内容，支持语音朗读和语音输入
    - **学习跟踪**: 学习进度和成绩记录

  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: https://api.yiask.com/v1
    description: Production server
  - url: http://localhost:8000/v1
    description: Development server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # User & Authentication
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [learner, content_provider]
        created_at:
          type: string
          format: date-time

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        display_name:
          type: string
        avatar_url:
          type: string
          nullable: true
        learning_preferences:
          type: object
          nullable: true

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
        user:
          $ref: '#/components/schemas/User'

    # Course Content
    CourseUnit:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        difficulty_level:
          type: string
          enum: [beginner, intermediate, advanced]
        subject:
          type: string
        vocabulary:
          type: array
          items:
            type: object
        grammar_points:
          type: array
          items:
            type: object
        status:
          type: string
          enum: [draft, published, archived]
        created_at:
          type: string
          format: date-time

    CourseMaterial:
      type: object
      properties:
        id:
          type: string
          format: uuid
        course_unit_id:
          type: string
          format: uuid
        material_type:
          type: string
          enum: [pdf, text, image]
        order:
          type: integer
        file_path:
          type: string
          nullable: true
        text_content:
          type: string
          nullable: true
        extracted_text:
          type: string
          nullable: true
        processed:
          type: boolean

    # Exercise System
    Exercise:
      type: object
      properties:
        id:
          type: string
          format: uuid
        course_unit_id:
          type: string
          format: uuid
        exercise_type:
          type: string
          enum: [q_and_a, image_based_q_and_a]
        question_text:
          type: string
        recommended_answer:
          type: string
        explanation:
          type: string
        difficulty_score:
          type: number
          format: float
        generation_status:
          type: string
          enum: [generating, pending_review, approved, rejected]
        created_at:
          type: string
          format: date-time

    ExerciseImage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        exercise_id:
          type: string
          format: uuid
        image_path:
          type: string
        caption:
          type: string
          nullable: true
        alt_text:
          type: string
        uploaded_by:
          type: string
          format: uuid
        upload_timestamp:
          type: string
          format: date-time

    VoiceFile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        exercise_id:
          type: string
          format: uuid
        file_path:
          type: string
        voice_type:
          type: string
          enum: [question, recommended_answer, evaluation]
        duration_ms:
          type: integer
        quality_score:
          type: number
          format: float

    # Voice Input & Evaluation
    VoiceInput:
      type: object
      properties:
        id:
          type: string
          format: uuid
        exercise_id:
          type: string
          format: uuid
        learner_id:
          type: string
          format: uuid
        audio_file_path:
          type: string
        transcribed_text:
          type: string
          nullable: true
        transcription_succeeded:
          type: boolean
        confidence_score:
          type: number
          format: float
          nullable: true
        input_timestamp:
          type: string
          format: date-time

    AnswerEvaluation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        voice_input_id:
          type: string
          format: uuid
        accuracy_score:
          type: number
          format: float
        grammar_score:
          type: number
          format: float
        feedback_text:
          type: string
        overall_score:
          type: number
          format: float
        evaluated_at:
          type: string
          format: date-time

    # Learning Progress
    LearningRecord:
      type: object
      properties:
        id:
          type: string
          format: uuid
        learner_id:
          type: string
          format: uuid
        exercise_id:
          type: string
          format: uuid
        completion_time_seconds:
          type: integer
        attempts_count:
          type: integer
        completion_status:
          type: string
          enum: [in_progress, completed, abandoned]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    # Generation Workflow
    GenerationTask:
      type: object
      properties:
        id:
          type: string
          format: uuid
        course_unit_id:
          type: string
          format: uuid
        exercise_id:
          type: string
          format: uuid
          nullable: true
        status:
          type: string
          enum: [pending, in_progress, completed, failed]
        task_type:
          type: string
          enum: [exercise_generation, voice_synthesis]
        progress_percentage:
          type: integer
        initiated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
        error_code:
          type: string
          nullable: true
          enum: [XINFERENCE_SERVICE_UNAVAILABLE, AUDIO_SYNTHESIS_FAILED,
                 FILE_STORAGE_ERROR, NETWORK_TIMEOUT, INVALID_VOICE_MODEL]

    # Review & Approval
    ReviewRecord:
      type: object
      properties:
        id:
          type: string
          format: uuid
        exercise_id:
          type: string
          format: uuid
        reviewer_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [approved, rejected, modified]
        review_comments:
          type: string
          nullable: true
        reviewed_at:
          type: string
          format: date-time

    # API Responses
    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          nullable: true

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              nullable: true

paths:
  # Authentication Endpoints
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/register:
    post:
      tags:
        - Authentication
      summary: User registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - role
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                role:
                  type: string
                  enum: [learner, content_provider]
      responses:
        '201':
          description: User created
        '400':
          description: Invalid input

  # Course Management
  /courses:
    get:
      tags:
        - Course Management
      summary: List published course units
      security: []
      responses:
        '200':
          description: List of courses
          content:
            application/json:
              schema:
                type: object
                properties:
                  courses:
                    type: array
                    items:
                      $ref: '#/components/schemas/CourseUnit'

    post:
      tags:
        - Course Management
      summary: Create new course unit (content providers only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseUnit'
      responses:
        '201':
          description: Course created
        '403':
          description: Insufficient permissions

  /courses/{course_id}:
    get:
      tags:
        - Course Management
      summary: Get course unit by ID
      parameters:
        - name: course_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Course details
        '404':
          description: Course not found

  /courses/{course_id}/materials:
    post:
      tags:
        - Course Management
      summary: Upload course material (PDF/text/image)
      parameters:
        - name: course_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                material_type:
                  type: string
                  enum: [pdf, text, image]
      responses:
        '201':
          description: Material uploaded
        '400':
          description: Invalid file

  # Exercise System
  /courses/{course_id}/exercises:
    get:
      tags:
        - Exercise System
      summary: Get exercises for a course (learners see approved only)
      parameters:
        - name: course_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of exercises
          content:
            application/json:
              schema:
                type: object
                properties:
                  exercises:
                    type: array
                    items:
                      $ref: '#/components/schemas/Exercise'

    post:
      tags:
        - Exercise System
      summary: Trigger exercise generation (content providers only)
      parameters:
        - name: course_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                num_exercises:
                  type: integer
                  minimum: 1
                  maximum: 20
                exercise_preferences:
                  type: object
      responses:
        '202':
          description: Generation task started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationTask'

  /exercises/{exercise_id}:
    get:
      tags:
        - Exercise System
      summary: Get exercise details with voice files and images
      parameters:
        - name: exercise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Exercise details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Exercise'
                  - type: object
                    properties:
                      exercise_images:
                        type: array
                        items:
                          $ref: '#/components/schemas/ExerciseImage'
                      voice_files:
                        type: array
                        items:
                          $ref: '#/components/schemas/VoiceFile'

  /exercises/{exercise_id}/generate-voice:
    post:
      tags:
        - Exercise System
      summary: Generate voice synthesis for exercise
      parameters:
        - name: exercise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                voice_type:
                  type: string
                  enum: [question, recommended_answer, evaluation]
      responses:
        '202':
          description: Voice generation started
        '400':
          description: Invalid voice type

  /exercises/{exercise_id}/retry-voice-generation:
    post:
      tags:
        - Exercise System
      summary: Retry voice generation for exercise (content providers only)
      description: |
        Retry voice generation after previous failure. Supports max 3 auto-retries.
        After all retries exhausted, content provider can manually trigger retry.
      parameters:
        - name: exercise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                force_retry:
                  type: boolean
                  description: Force retry even if max attempts reached (admin only)
              required: []
      responses:
        '202':
          description: Voice generation retry started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationTask'
        '400':
          description: Invalid exercise or voice generation already in progress
        '429':
          description: Max retry attempts exceeded
        '403':
          description: Insufficient permissions (content providers only)

  # Voice Input & Evaluation
  /exercises/{exercise_id}/voice-input:
    post:
      tags:
        - Voice Processing
      summary: Submit voice input for an exercise
      parameters:
        - name: exercise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio_file
              properties:
                audio_file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Voice input submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceInput'

  /voice-input/{voice_input_id}/evaluate:
    post:
      tags:
        - Voice Processing
      summary: Evaluate voice input (real-time)
      parameters:
        - name: voice_input_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Evaluation complete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnswerEvaluation'

  # Learning Progress
  /learners/{learner_id}/progress:
    get:
      tags:
        - Learning Progress
      summary: Get learner progress records
      parameters:
        - name: learner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Learning progress
          content:
            application/json:
              schema:
                type: object
                properties:
                  records:
                    type: array
                    items:
                      $ref: '#/components/schemas/LearningRecord'

  /learning-records:
    post:
      tags:
        - Learning Progress
      summary: Create learning record (start/continue practice)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - learner_id
                - exercise_id
              properties:
                learner_id:
                  type: string
                  format: uuid
                exercise_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Learning record created

  /learning-records/{record_id}:
    patch:
      tags:
        - Learning Progress
      summary: Update learning record (mark as completed)
      parameters:
        - name: record_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                completion_status:
                  type: string
                  enum: [in_progress, completed, abandoned]
                completion_time_seconds:
                  type: integer
      responses:
        '200':
          description: Learning record updated

  # Content Review & Approval
  /exercises/{exercise_id}/review:
    post:
      tags:
        - Content Review
      summary: Submit review for exercise (content providers only)
      parameters:
        - name: exercise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [approved, rejected, modified]
                review_comments:
                  type: string
                  nullable: true
      responses:
        '201':
          description: Review submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewRecord'

  /courses/{course_id}/pending-reviews:
    get:
      tags:
        - Content Review
      summary: Get pending reviews for a course (content providers only)
      parameters:
        - name: course_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of pending exercises
          content:
            application/json:
              schema:
                type: object
                properties:
                  exercises:
                    type: array
                    items:
                      $ref: '#/components/schemas/Exercise'

  # Generation Task Status
  /generation-tasks/{task_id}:
    get:
      tags:
        - Generation Tasks
      summary: Get generation task status
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerationTask'
